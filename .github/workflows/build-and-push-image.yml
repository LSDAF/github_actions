name: 🐳 Build and Push Docker Image by SHA

run-name: Build and push image for commit ${{ github.event.inputs.git_sha }} with tags

on:
  workflow_dispatch:
    inputs:
      git_sha:
        description: 'Git SHA commit to build'
        required: true
        type: string
      github_token:
        description: 'GitHub Personal Access Token with read:org permissions'
        required: true
        type: string
      latest:
        description: 'Tag the image as latest'
        required: false
        type: boolean
        default: false
      additional_tags:
        description: 'Additional tags (semicolon-separated)'
        required: false
        type: string
        default: ''

jobs:
  build-and-push:
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 15
    permissions:
      actions: write
      checks: write
      contents: write
      packages: write

    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔒 Check user token permissions
        id: check_permissions
        run: |
          # Get the authenticated user's information
          USER_INFO=$(curl -s -H "Authorization: token ${{ github.event.inputs.github_token }}" \
            https://api.github.com/user)

          # Extract username
          USERNAME=$(echo "$USER_INFO" | jq -r '.login')
          echo "Authenticated as: $USERNAME"

          # Check if the user is an organization member and their role
          ORG_MEMBERSHIP=$(curl -s -H "Authorization: token ${{ github.event.inputs.github_token }}" \
            https://api.github.com/orgs/LSDAF/memberships/$USERNAME)

          # Check if the response contains an error
          ERROR=$(echo "$ORG_MEMBERSHIP" | jq -r '.message')
          if [[ "$ERROR" == "Not Found" ]]; then
            echo "::error::User $USERNAME is not a member of the LSDAF organization"
            exit 1
          fi

          # Extract the user's role in the organization
          ROLE=$(echo "$ORG_MEMBERSHIP" | jq -r '.role')
          echo "User role in organization: $ROLE"

          # Check if the user is an admin
          if [[ "$ROLE" == "admin" ]]; then
            echo "User is an organization admin. Proceeding with the workflow."
          elif [[ "$ROLE" == "member" ]]; then
            # Check if the user has maintainer permissions
            ORG_PERMISSION=$(curl -s -H "Authorization: token ${{ github.event.inputs.github_token }}" \
              https://api.github.com/orgs/LSDAF/memberships/$USERNAME | jq -r '.role')

            if [[ "$ORG_PERMISSION" == "maintainer" ]]; then
              echo "::error::User $USERNAME is a maintainer. Only organization admins can push images."
              exit 1
            else
              echo "::error::User $USERNAME is a regular member. Only organization admins can push images."
              exit 1
            fi
          else
            echo "::error::Unknown role: $ROLE. Only organization admins can push images."
            exit 1
          fi

      - name: 🔒 Check github commit existence
        id: check_github_commit
        run: |
          # Check if the repository exists
          REPO_EXISTS=$(curl -s -H "Authorization: token ${{ github.event.inputs.github_token }}" \
            https://api.github.com/repos/LSDAF/lsadf_backend/commits/${{ github.event.inputs.git_sha }})

          ERROR=$(echo "$REPO_EXISTS" | jq -r '.message')
          if [[ "$ERROR" == "Not Found" ]]; then
            echo "::error::Git commit SHA ${{ github.event.inputs.git_sha }} not found in the repository"
            exit 1
          fi
          echo "Commit ${{ github.event.inputs.git_sha}} exists."
          
      - name: 🔐 Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.event.inputs.github_token }}

      - name: 🔒 Check docker image existence
        id: check_docker_image
        run: |
          # Check if the image already exists using Docker CLI
          echo "Checking if image ghcr.io/lsdaf/lsadf_api:${{ github.event.inputs.git_sha }} already exists..."

          # Try to inspect the image (this will fail if the image doesn't exist)
          if docker manifest inspect ghcr.io/lsdaf/lsadf_api:${{ github.event.inputs.git_sha }} > /dev/null 2>&1; then
            echo "Image with tag ${{ github.event.inputs.git_sha }} already exists."
            echo "Note: The workflow will continue and may add additional tags to the existing image."
          else
            echo "Image with tag ${{ github.event.inputs.git_sha }} does not exist yet. Will build and push."
          fi

      - name: Git clone lsadf_backend project
        uses: GuillaumeFalourd/clone-github-repo-action@v2.3
        with:
          branch: 'master'
          owner: 'LSDAF'
          repository: 'lsadf_backend'

      - name: 📥 Checkout code at specific commit
        run: |
          cd lsadf_backend/
          git checkout ${{ github.event.inputs.git_sha }}
          echo "Checked out at ${{ github.event.inputs.git_sha }}"
          cd ../

      - name: Prepare tags
        id: prep
        run: |
          TAGS="ghcr.io/lsdaf/lsadf_api:${{ github.event.inputs.git_sha }}"

          # Add latest tag if requested
          if [[ "${{ github.event.inputs.latest }}" == "true" ]]; then
            TAGS="$TAGS,ghcr.io/lsdaf/lsadf_api:latest"
          fi

          # Add additional tags if provided
          if [[ -n "${{ github.event.inputs.additional_tags }}" ]]; then
            IFS=';' read -ra ADDITIONAL_TAGS <<< "${{ github.event.inputs.additional_tags }}"
            for tag in "${ADDITIONAL_TAGS[@]}"; do
              if [[ -n "$tag" ]]; then
                TAGS="$TAGS,ghcr.io/lsdaf/lsadf_api:$tag"
              fi
            done
          fi

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Tags to be used: $TAGS"
          
      - name: Check current working directory
        id: check_cwd
        run: |
          echo $PWD
          ls
          echo "pwd=$PWD" >> $GITHUB_OUTPUT

      - name: Tag & Push
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64, linux/arm64
          file: ${{ steps.check_cwd.outputs.pwd }}/lsadf_backend/docker/Dockerfile
          context: ${{ steps.check_cwd.outputs.pwd }}/lsadf_backend/
          push: true
          tags: ${{ steps.prep.outputs.tags }}
